name: ğŸš€ ë°°í¬ (SSHë¡œ ì„œë²„ì—ì„œ ë¹Œë“œí•˜ê³  docker compose ì‹¤í–‰)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (Actions ëŸ¬ë„ˆ ë‚´ë¶€)
      - name: ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2ï¸âƒ£ SSHë¡œ ì„œë²„ ì ‘ì† â†’ ë ˆí¬ í´ë¡ /ë¦¬ì…‹, ë°±ì—”ë“œ ë¹Œë“œ, docker compose ì‹¤í–‰s
      - name: ğŸŒ SSH â†’ ì„œë²„ì—ì„œ í´ë¡ /ë¦¬ì…‹/ë¹Œë“œ/ë°°í¬
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: 22
          script: |
            set -euo pipefail

            echo "=== ì„œë²„ ë°°í¬ ì‹œì‘ ==="
            # ë ˆí¬ì§€í† ë¦¬ URLì„ ëª…ì‹œ (ì‹œí¬ë¦¿ ì—†ì´ HTTPSë¡œ í´ë¡ )
            REPO="https://github.com/gwondev/gwon.git" 
            PROJECT_DIR="$HOME/gwon"

            # ë ˆí¬ì§€í† ë¦¬ê°€ ì—†ìœ¼ë©´ í´ë¡ 
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ë ˆí¬ì§€í† ë¦¬ í´ë¡ : ${REPO} â†’ ${PROJECT_DIR}"
              git clone "$REPO" "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"
            echo "ì›ê²© ë³€ê²½ì‚¬í•­ ê°•ì œ ë™ê¸°í™” (origin/mainìœ¼ë¡œ ë¦¬ì…‹)"
            git fetch --all --prune
            git reset --hard origin/main
            

            # ë°±ì—”ë“œê°€ ì¡´ì¬í•˜ë©´ ë¹Œë“œ ìˆ˜í–‰ (ì„œë²„ì— JDK í•„ìš”)
            if [ -d backend ]; then
              echo "ë°±ì—”ë“œ ë¹Œë“œ ì‹œì‘: ./gradlew clean bootJar -x test"
              cd backend
              chmod +x ./gradlew || true
              ./gradlew clean bootJar -x test
              cd -
            else
              echo "ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ì—†ìŒ â€” ë¹Œë“œ ê±´ë„ˆëœ€"
            fi

            # í•„ìš” ì‹œ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ìƒì„± (idempotent)
            echo "docker ë„¤íŠ¸ì›Œí¬ 'global_network' í™•ì¸/ìƒì„±"
            docker network create global_network || true

            # í”„ë¡ íŠ¸ì—”ë“œìš© í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ReactëŠ” REACT_APP_ ì ‘ë‘ì‚¬ ì‚¬ìš©)
            echo "í”„ë¡ íŠ¸ì—”ë“œ .env íŒŒì¼ ìƒì„±/ê°±ì‹  (frontend/.env)"
            echo "REACT_APP_GPT_API=${{ secrets.GPT_API }}" > frontend/.env

            # ê¸°ì¡´ ìŠ¤íƒ ì¤‘ì§€ ë° ìµœì‹  ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘
            echo "ê¸°ì¡´ Docker Compose ìŠ¤íƒ ì¤‘ì§€"
            docker compose down || true

            echo "Docker Compose: ì´ë¯¸ì§€ ë¹Œë“œ ë° ì„œë¹„ìŠ¤ ì‹œì‘"
            docker compose build --pull --parallel || true
            docker compose up -d

            echo "=== ë°°í¬ ì™„ë£Œ: ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ==="
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

            echo "ë¡œê·¸ í™•ì¸: docker compose logs -f"
